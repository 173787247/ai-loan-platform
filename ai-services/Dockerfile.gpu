# AI助贷招标平台 - AI服务Dockerfile (GPU版本)

FROM pytorch/pytorch:2.7.0-cuda12.8-cudnn9-devel

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    build-essential \
    git \
    wget \
    curl \
    ninja-build \
    tesseract-ocr \
    tesseract-ocr-chi-sim \
    libgl1-mesa-glx \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    && rm -rf /var/lib/apt/lists/*

# 配置pip使用清华镜像源
RUN pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple

# 安装基础Python依赖
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install pandas numpy scikit-learn matplotlib lightgbm catboost xgboost ipykernel transformers datasets peft accelerate bitsandbytes sentencepiece protobuf tqdm

# 卸载预装的torch相关包
RUN pip uninstall -y torch torchvision torchaudio

# 安装稳定的PyTorch版本 (CUDA 12.1兼容)
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121

# 验证PyTorch版本
RUN python -c "import torch; print(f'PyTorch Version: {torch.__version__}'); print(f'CUDA Version: {torch.version.cuda}')"

# 安装vLLM from source
RUN git clone --depth 1 https://github.com/vllm-project/vllm.git /tmp/vllm && \
    cd /tmp/vllm && \
    python use_existing_torch.py && \
    sed -i 's/license = \"Apache-2.0\"/license = {file = \"LICENSE\"}/' pyproject.toml && \
    sed -i '/^\s*license-files\s*=.*/d' pyproject.toml && \
    pip install -r requirements/build.txt && \
    pip install setuptools_scm && \
    export MAX_JOBS=$(nproc) && \
    export VLLM_TARGET_DEVICE=cuda && \
    pip install . --no-build-isolation && \
    cd / && rm -rf /tmp/vllm

# 复制requirements文件
COPY requirements-gpu.txt requirements.txt

# 安装项目特定依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 创建上传目录和模型目录
RUN mkdir -p uploads models

# 暴露端口
EXPOSE 8000

# 设置环境变量
ENV CUDA_VISIBLE_DEVICES=0
ENV PYTHONPATH=/app

# 启动命令
CMD ["python", "main.py"]
